import logging
import subprocess
from pathlib import Path
import os
from config_file import config

log_file = config.LOGS_PATH / "framing_videos.log"
log_file.parent.mkdir(parents=True, exist_ok=True)  # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[
        logging.FileHandler(log_file, encoding='utf-8'),
        logging.StreamHandler()
    ]
)

frames_folder = config.IMAGES_PATH / "videos-screenshots"

videos = os.listdir(config.VIDEOS_FOLDER)
existing_frame_folders = os.listdir(frames_folder)

videos_to_frames = list(set(videos).difference(set(existing_frame_folders)))


# ffmpeg -i "F:\Videos\Hitman_ Blood Money.mp4" -vf "select='gt(scene,0.1)',showinfo" -vsync vfr "images/videos-screenshots/Hitman_ Blood Money/frame_%04d.png"

for i, video in enumerate(videos_to_frames):
    print(f"üì• –§—Ä–µ–π–º–∏—Ä–æ–≤–∞–Ω–∏–µ: {video}")
    logging.info(f"üì• –§—Ä–µ–π–º–∏—Ä–æ–≤–∞–Ω–∏–µ: {video}")

    os.makedirs(frames_folder / video, exist_ok=True)

    command = [
        "ffmpeg",
        "-i", f"{config.VIDEOS_FOLDER}/{video}",
        "-vf", "select='gt(scene,0.2)',showinfo",
        "-fps_mode", "vfr",
        f"{frames_folder}/{video}/frame_%04d.png"
    ]

    try:
        subprocess.run(command, check=True)
        print(f"‚úÖ –ì–æ—Ç–æ–≤–æ [{(i + 1) + len(existing_frame_folders)}/{len(videos)}]: {video}\n")
        logging.info(f"‚úÖ –ì–æ—Ç–æ–≤–æ [{(i + 1) + len(existing_frame_folders)}/{len(videos)}]: {video}")
    except subprocess.CalledProcessError:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ—Ä–µ–π–º–∏—Ä–æ–≤–∞–Ω–∏–∏: {video}\n")
        logging.info(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ—Ä–µ–π–º–∏—Ä–æ–≤–∞–Ω–∏–∏: {video}\n")